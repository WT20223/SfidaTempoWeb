<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sfida del Tempo</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { 
            background-color: #f8fafc;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        @keyframes pulse-custom {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .animate-pulse-custom { animation: pulse-custom 2s infinite; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ICONE INTEGRATE ---
        const IconBase = ({ children, className, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );
        const Sparkles = (p) => <IconBase {...p}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275Z"/></IconBase>;
        const Trash2 = (p) => <IconBase {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>;
        const History = (p) => <IconBase {...p}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></IconBase>;
        const Trophy = (p) => <IconBase {...p}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M9 22a7 7 0 1 0 6 0A7 7 0 0 0 9 22v-1"/><path d="M11 22v-1"/></IconBase>;
        const AlertCircle = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></IconBase>;
        const ShoppingBag = (p) => <IconBase {...p}><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></IconBase>;
        const RefreshCw = (p) => <IconBase {...p}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></IconBase>;
        const X = (p) => <IconBase {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>;
        const WifiOff = (p) => <IconBase {...p}><line x1="1" x2="23" y1="1" y2="23"/><path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"/><path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"/><path d="M10.71 5.05A16 16 0 0 1 22.58 9"/><path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" x2="12.01" y1="20" y2="20"/></IconBase>;
        const Users = (p) => <IconBase {...p}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></IconBase>;
        const Edit2 = (p) => <IconBase {...p}><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></IconBase>;
        const Plus = (p) => <IconBase {...p}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>;
        const Save = (p) => <IconBase {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconBase>;
        const Home = (p) => <IconBase {...p}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></IconBase>;
        const Pencil = (p) => <IconBase {...p}><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></IconBase>;

        // --- DATI ---
        const STORAGE_KEY = 'family_app_data_v1';
        
        const DEFAULT_CONFIG = {
            familyName: "Casa Nostra",
            gains: [
                { id: 'def_1', pts: 5, label: "üåÖ Pronta Mattino", sub: "Entro le 7:40", emoji: "‚ö°" },
                { id: 'def_2', pts: 5, label: "üåô Pronta Sera", sub: "Luci spente 21:30", emoji: "üõå" },
                { id: 'def_3', pts: 3, label: "üöø Doccia", sub: "Veloce", emoji: "üöø" },
                { id: 'def_4', pts: 3, label: "üìö Voto 8", sub: "Brava!", emoji: "üìò" },
                { id: 'def_5', pts: 5, label: "üìö Voto 9", sub: "Ottimo!", emoji: "üåü" },
                { id: 'def_6', pts: 8, label: "üèÜ Voto 10", sub: "TOP!", emoji: "üëë", special: true }
            ],
            losses: [
                { id: 'def_l1', pts: -2, label: "üó£Ô∏è Ripetere", sub: "Non ascolta", emoji: "üì£" },
                { id: 'def_l2', pts: -2, label: "üò† Sgarbata", sub: "Rispostaccia", emoji: "üò°" },
                { id: 'def_l3', pts: -5, label: "üß∏ Disordine", sub: "Dopo 21:00", emoji: "üßπ" },
                { id: 'def_l4', pts: -50, label: "‚õî BUGIA", sub: "Grave", emoji: "ü§•", isBig: true }
            ],
            shop: [
                { id: 'def_s1', name: "20 min Social/TV", cost: 20, icon: "üì∫" },
                { id: 'def_s2', name: "Salta Compito", cost: 15, icon: "‚ú®" },
                { id: 'def_s3', name: "Roblox 25 min", cost: 25, icon: "üéÆ" },
                { id: 'def_s4', name: "Cena Sabato", cost: 50, icon: "üçï" }
            ]
        };

        const ConfirmModal = ({ isOpen, title, message, onConfirm, onCancel, isDestructive }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in duration-200">
                    <div className="bg-white rounded-3xl shadow-2xl max-w-xs w-full p-5 transform scale-100 transition-all border border-slate-100">
                        <h3 className={`text-xl font-bold mb-3 ${isDestructive ? 'text-red-600' : 'text-slate-800'}`}>{title}</h3>
                        <p className="text-slate-600 mb-6 leading-relaxed text-sm">{message}</p>
                        <div className="flex gap-2 justify-end">
                            <button onClick={onCancel} className="px-4 py-2.5 rounded-xl font-bold text-slate-500 hover:bg-slate-100 transition-colors text-sm">Annulla</button>
                            <button onClick={() => { if (onConfirm) onConfirm(); }} className={`px-5 py-2.5 rounded-xl font-bold text-white shadow-lg transform active:scale-95 transition-all text-sm ${isDestructive ? 'bg-red-500 hover:bg-red-600 shadow-red-200' : 'bg-blue-600 hover:bg-blue-700 shadow-blue-200'}`}>Conferma</button>
                        </div>
                    </div>
                </div>
            );
        };

        const UpsertItemModal = ({ isOpen, type, initialData, onClose, onSave }) => {
            const [formData, setFormData] = useState({ label: '', sub: '', val: '', emoji: '' });

            useEffect(() => {
                if (isOpen) {
                    if (initialData) {
                        setFormData({
                            label: initialData.label || initialData.name,
                            sub: initialData.sub || '',
                            val: Math.abs(initialData.pts || initialData.cost || 0),
                            emoji: initialData.emoji || initialData.icon || ''
                        });
                    } else {
                        setFormData({ label: '', sub: '', val: '', emoji: '' });
                    }
                }
            }, [isOpen, initialData]);

            if (!isOpen) return null;

            const handleSubmit = () => {
                if (!formData.label || !formData.val) return alert("Inserisci almeno Nome e Valore");
                onSave({ ...formData, type, id: initialData?.id });
                onClose();
            };

            const isEdit = !!initialData;
            const title = isEdit ? 'Modifica' : `Aggiungi ${type === 'shop' ? 'Premio' : type === 'gain' ? 'Azione' : 'Penalit√†'}`;

            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
                    <div className="bg-white rounded-3xl shadow-2xl max-w-sm w-full p-6">
                        <h3 className="text-xl font-bold mb-4 text-slate-800 flex items-center gap-2">
                            {isEdit ? <Pencil className="w-5 h-5 text-blue-500" /> : <Plus className="w-5 h-5 text-blue-500" />}
                            {title}
                        </h3>
                        <div className="space-y-3">
                            <div><label className="text-xs font-bold text-slate-400 uppercase">Emoji</label><input type="text" placeholder="es. üöÄ" className="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 focus:outline-blue-500 text-2xl text-center" maxLength={2} value={formData.emoji} onChange={e => setFormData({...formData, emoji: e.target.value})} /></div>
                            <div><label className="text-xs font-bold text-slate-400 uppercase">Nome</label><input type="text" placeholder="Nome" className="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 focus:outline-blue-500 font-bold" value={formData.label} onChange={e => setFormData({...formData, label: e.target.value})} /></div>
                            {type !== 'shop' && (<div><label className="text-xs font-bold text-slate-400 uppercase">Sottotitolo</label><input type="text" placeholder="Dettagli" className="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 focus:outline-blue-500" value={formData.sub} onChange={e => setFormData({...formData, sub: e.target.value})} /></div>)}
                            <div><label className="text-xs font-bold text-slate-400 uppercase">{type === 'shop' ? 'Costo (XP)' : 'Valore (XP)'}</label><input type="number" className="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 focus:outline-blue-500 font-mono font-bold" value={formData.val} onChange={e => setFormData({...formData, val: e.target.value})} /></div>
                        </div>
                        <div className="flex gap-2 justify-end mt-6">
                            <button onClick={onClose} className="px-4 py-3 rounded-xl font-bold text-slate-500 hover:bg-slate-100">Annulla</button>
                            <button onClick={handleSubmit} className="px-6 py-3 rounded-xl font-bold text-white bg-blue-600 hover:bg-blue-700 shadow-lg shadow-blue-200">Salva</button>
                        </div>
                    </div>
                </div>
            );
        };

        function App() {
            const [score, setScore] = useState(0);
            const [history, setHistory] = useState([]);
            const [config, setConfig] = useState(DEFAULT_CONFIG);
            const [editMode, setEditMode] = useState(false);
            const [animateScore, setAnimateScore] = useState(false);
            const prevScoreRef = useRef(0);

            const [confirmModal, setConfirmModal] = useState({ isOpen: false, title: '', message: '', onConfirm: null, isDestructive: false });
            const [upsertModal, setUpsertModal] = useState({ isOpen: false, type: 'gain', initialData: null });

            // Caricamento Iniziale
            useEffect(() => {
                const savedData = localStorage.getItem(STORAGE_KEY);
                if (savedData) {
                    try {
                        const parsed = JSON.parse(savedData);
                        if (parsed.score !== undefined) setScore(parsed.score);
                        if (parsed.history) setHistory(parsed.history);
                        if (parsed.config) setConfig(parsed.config);
                    } catch (e) { console.error("Err load", e); }
                }
            }, []);

            // Salvataggio
            const saveData = (newScore, newHistory, newConfig) => {
                const data = {
                    score: newScore !== undefined ? newScore : score,
                    history: newHistory !== undefined ? newHistory : history,
                    config: newConfig !== undefined ? newConfig : config
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                
                if (newScore !== undefined) setScore(newScore);
                if (newHistory !== undefined) setHistory(newHistory);
                if (newConfig !== undefined) setConfig(newConfig);
            };

            useEffect(() => {
                if (score !== prevScoreRef.current) {
                    setAnimateScore(true);
                    const timer = setTimeout(() => setAnimateScore(false), 400);
                    prevScoreRef.current = score;
                    return () => clearTimeout(timer);
                }
            }, [score]);

            const executeAction = (points, description, type) => {
                const newEntry = { id: Date.now().toString(), desc: description, points, timestamp: Date.now(), type };
                const newScore = score + points;
                const newHistory = [newEntry, ...history];
                saveData(newScore, newHistory, undefined);
                setConfirmModal(prev => ({ ...prev, isOpen: false }));
            };

            const handleReset = () => {
                saveData(0, [], config); 
                setConfirmModal(prev => ({ ...prev, isOpen: false }));
            };

            const handleSaveItem = (data) => {
                const isEdit = !!data.id;
                const newItem = { 
                    id: data.id || Date.now().toString(), 
                    pts: parseInt(data.val), 
                    cost: parseInt(data.val),
                    label: data.label,
                    name: data.label,
                    sub: data.sub, 
                    emoji: data.emoji || (data.type === 'shop' ? 'üéÅ' : '‚ö°'),
                    icon: data.emoji || 'üéÅ'
                };

                const newConfig = { ...config };
                const listKey = data.type === 'gain' ? 'gains' : data.type === 'loss' ? 'losses' : 'shop';
                if (data.type === 'loss') newItem.pts = -Math.abs(newItem.pts);

                if (isEdit) {
                    newConfig[listKey] = newConfig[listKey].map(item => item.id === newItem.id ? { ...item, ...newItem, isBig: item.isBig, special: item.special } : item);
                } else {
                    newConfig[listKey] = [...newConfig[listKey], newItem];
                }
                saveData(undefined, undefined, newConfig);
            };

            const removeItem = (type, id) => {
                if (!confirm("Eliminare?")) return;
                const newConfig = { ...config };
                if (type === 'gain') newConfig.gains = newConfig.gains.filter(i => i.id !== id);
                if (type === 'loss') newConfig.losses = newConfig.losses.filter(i => i.id !== id);
                if (type === 'shop') newConfig.shop = newConfig.shop.filter(i => i.id !== id);
                saveData(undefined, undefined, newConfig);
            };

            const updateTitle = () => {
                const newTitle = prompt("Nome Famiglia:", config.familyName);
                if (newTitle) {
                    const newConfig = { ...config, familyName: newTitle };
                    saveData(undefined, undefined, newConfig);
                }
            };

            const handleItemClick = (item, type) => {
                if (editMode) {
                    setUpsertModal({ isOpen: true, type, initialData: item });
                } else {
                    if (type === 'gain') executeAction(item.pts, item.label, "gain");
                    if (type === 'loss') {
                        if (item.isBig) setConfirmModal({isOpen: true, title: "Confermi?", message: `Togli ${Math.abs(item.pts)} punti?`, onConfirm: () => executeAction(item.pts, item.label, "loss"), isDestructive: true });
                        else executeAction(item.pts, item.label, "loss");
                    }
                    if (type === 'shop') {
                        setConfirmModal({isOpen: true, title: "Riscatta", message: `Spendere ${item.cost} XP per ${item.name}?`, onConfirm: () => executeAction(-item.cost, `üõçÔ∏è Preso: ${item.name}`, "shop") });
                    }
                }
            };

            const getLevel = (xp) => {
                if (xp < 0) return { label: "IN DEBITO", color: "bg-red-500", text: "text-red-600", bg: "bg-red-50" };
                if (xp >= 200) return { label: "LEGGENDARIO", color: "bg-yellow-500", text: "text-yellow-600", bg: "bg-yellow-50" };
                if (xp >= 100) return { label: "SUPER PRO", color: "bg-green-500", text: "text-green-600", bg: "bg-green-50" };
                if (xp >= 50) return { label: "PRO", color: "bg-blue-500", text: "text-blue-600", bg: "bg-blue-50" };
                return { label: "PRINCIPIANTE", color: "bg-slate-400", text: "text-slate-600", bg: "bg-slate-50" };
            };

            const currentLevel = getLevel(score);

            return (
                <div className={`min-h-screen font-sans selection:bg-pink-200 pb-32 transition-colors duration-500 ${currentLevel.bg}`} style={{ zoom: '1.2' }}>
                    <ConfirmModal {...confirmModal} onCancel={() => setConfirmModal(prev => ({...prev, isOpen: false}))} />
                    <UpsertItemModal isOpen={upsertModal.isOpen} type={upsertModal.type} initialData={upsertModal.initialData} onClose={() => setUpsertModal({...upsertModal, isOpen: false})} onSave={handleSaveItem} />

                    <div className="sticky top-0 z-40 bg-white/90 backdrop-blur-lg border-b border-slate-200/50 shadow-sm transition-all">
                        <div className="max-w-md w-full mx-auto px-5 py-3 flex justify-between items-center">
                            <div>
                                <div className="flex items-center gap-2 mb-1 cursor-pointer" onClick={editMode ? updateTitle : undefined}>
                                    <div className="bg-pink-100 p-1.5 rounded-lg shadow-sm"><Home className="text-pink-500 w-4 h-4" /></div>
                                    <h1 className={`text-lg font-bold text-slate-800 ${editMode ? 'underline decoration-dashed decoration-pink-300' : ''}`}>{config.familyName}</h1>
                                    {editMode && <Edit2 className="w-3 h-3 text-slate-400" />}
                                </div>
                                <span className={`text-[10px] uppercase tracking-wider font-bold px-3 py-1 rounded-full text-white shadow-sm ${currentLevel.color}`}>{currentLevel.label}</span>
                            </div>
                            <div className="flex items-center gap-4">
                                <div className={`text-right transform transition-all duration-300 ${animateScore ? 'scale-125' : 'scale-100'}`}>
                                    <div className={`text-4xl font-black drop-shadow-sm transition-colors duration-300 ${animateScore ? 'text-orange-500' : currentLevel.text}`}>
                                        {score} <span className="text-base font-bold text-slate-400">XP</span>
                                    </div>
                                </div>
                                <button onClick={() => setEditMode(!editMode)} className={`p-2 rounded-full transition-all ${editMode ? 'bg-slate-800 text-white shadow-lg rotate-12' : 'bg-slate-100 text-slate-400 hover:bg-slate-200'}`}>
                                    {editMode ? <Save className="w-5 h-5" /> : <Edit2 className="w-5 h-5" />}
                                </button>
                            </div>
                        </div>
                    </div>

                    <div className="max-w-md w-full mx-auto p-5 space-y-8">
                        {editMode && <div className="bg-yellow-50 border border-yellow-200 p-3 rounded-xl text-xs text-yellow-800 text-center font-bold mb-4 animate-pulse">üîß MODIFICA: Clicca per cambiare, X per eliminare</div>}

                        <section className="animate-in slide-in-from-bottom-4 duration-500">
                            <div className="flex items-center justify-between mb-4 px-1">
                                <div className="flex items-center gap-3"><div className="bg-green-100 p-2 rounded-xl"><Trophy className="w-6 h-6 text-green-600" /></div><h2 className="font-bold text-slate-700 text-lg">Guadagna Punti</h2></div>
                                {editMode && <button onClick={() => setUpsertModal({isOpen: true, type: 'gain', initialData: null})} className="bg-green-500 text-white p-2 rounded-lg shadow hover:bg-green-600"><Plus className="w-5 h-5"/></button>}
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                {config.gains.map((item) => (
                                    <button key={item.id} onClick={() => handleItemClick(item, 'gain')} className={`relative p-4 rounded-3xl border-2 shadow-sm active:scale-95 transition-all text-left flex flex-col justify-between h-32 ${item.special ? "bg-gradient-to-br from-amber-50 to-orange-50 border-orange-100 hover:border-orange-400 col-span-2" : "bg-white border-slate-100 hover:border-green-400"} ${editMode ? 'border-dashed border-slate-300 bg-slate-50' : ''}`}>
                                        {editMode && <div onClick={(e) => {e.stopPropagation(); removeItem('gain', item.id)}} className="absolute -top-2 -right-2 bg-red-500 text-white p-1.5 rounded-full shadow-md cursor-pointer z-10"><X className="w-4 h-4"/></div>}
                                        <div className="flex justify-between items-start"><div className="text-3xl">{item.emoji}</div><span className={`font-bold text-lg ${item.special ? "text-orange-600" : "text-green-600"}`}>+{item.pts}</span></div>
                                        <div><div className={`font-bold text-base leading-tight ${item.special ? "text-orange-900" : "text-slate-700"}`}>{item.label}</div><div className="text-xs text-slate-400 font-medium mt-1">{item.sub}</div></div>
                                    </button>
                                ))}
                            </div>
                        </section>

                        <section className="animate-in slide-in-from-bottom-8 duration-500 delay-75">
                            <div className="flex items-center justify-between mb-4 px-1 mt-6">
                                <div className="flex items-center gap-3"><div className="bg-red-100 p-2 rounded-xl"><AlertCircle className="w-6 h-6 text-red-600" /></div><h2 className="font-bold text-slate-700 text-lg">Penalit√†</h2></div>
                                {editMode && <button onClick={() => setUpsertModal({isOpen: true, type: 'loss', initialData: null})} className="bg-red-500 text-white p-2 rounded-lg shadow hover:bg-red-600"><Plus className="w-5 h-5"/></button>}
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                {config.losses.map((item) => (
                                    <button key={item.id} onClick={() => handleItemClick(item, 'loss')} className={`bg-white p-4 rounded-3xl border-2 hover:border-red-300 shadow-sm active:scale-95 text-left flex flex-col justify-between group transition-colors relative ${item.isBig ? 'col-span-2 border-red-200 bg-red-50 h-24' : 'border-red-50 h-28'} ${editMode ? 'border-dashed border-slate-300 bg-slate-50' : ''}`}>
                                        {editMode && <div onClick={(e) => {e.stopPropagation(); removeItem('loss', item.id)}} className="absolute -top-2 -right-2 bg-red-500 text-white p-1.5 rounded-full shadow-md cursor-pointer z-10"><X className="w-4 h-4"/></div>}
                                        <div className={`flex justify-between items-start ${item.isBig ? 'items-center' : ''}`}><div className="text-2xl mr-2">{item.emoji}</div><span className="text-red-500 font-bold text-lg">{item.pts}</span></div>
                                        <div><div className={`font-bold text-base ${item.isBig ? 'text-red-900' : 'text-slate-700'} group-hover:text-red-700`}>{item.label}</div><div className="text-xs text-slate-400">{item.sub}</div></div>
                                    </button>
                                ))}
                            </div>
                        </section>

                        <section className="animate-in slide-in-from-bottom-8 duration-500 delay-100">
                            <div className="flex items-center justify-between mb-4 px-1 mt-6">
                                <div className="flex items-center gap-3"><div className="bg-purple-100 p-2 rounded-xl"><ShoppingBag className="w-6 h-6 text-purple-600" /></div><h2 className="font-bold text-slate-700 text-lg">Negozio Premi</h2></div>
                                {editMode && <button onClick={() => setUpsertModal({isOpen: true, type: 'shop', initialData: null})} className="bg-purple-500 text-white p-2 rounded-lg shadow hover:bg-purple-600"><Plus className="w-5 h-5"/></button>}
                            </div>
                            <div className="space-y-3">
                                {config.shop.map((item) => (
                                    <button key={item.id} disabled={!editMode && score < item.cost} onClick={() => handleItemClick(item, 'shop')} className={`w-full p-4 rounded-3xl border-2 flex justify-between items-center transition-all relative ${score >= item.cost ? "bg-white border-purple-100 hover:border-purple-400 active:scale-[0.98] cursor-pointer shadow-md" : "bg-slate-50 border-slate-100 opacity-60 cursor-not-allowed grayscale"} ${editMode ? 'opacity-100 cursor-pointer border-dashed border-slate-300 bg-slate-50' : ''}`}>
                                        {editMode && <div onClick={(e) => {e.stopPropagation(); removeItem('shop', item.id)}} className="absolute -top-2 -right-2 bg-red-500 text-white p-1.5 rounded-full shadow-md cursor-pointer z-10"><X className="w-4 h-4"/></div>}
                                        <div className="flex items-center gap-4"><div className="bg-slate-50 w-12 h-12 rounded-2xl flex items-center justify-center text-2xl shadow-inner text-slate-700">{item.icon}</div><span className="font-bold text-slate-700 text-base">{item.name}</span></div>
                                        <span className={`font-bold px-4 py-2 rounded-xl text-sm ${score >= item.cost ? 'bg-purple-100 text-purple-700' : 'bg-slate-200 text-slate-500'}`}>{item.cost} XP</span>
                                    </button>
                                ))}
                            </div>
                        </section>

                        <section className="bg-white/90 backdrop-blur-sm rounded-[2rem] p-6 shadow-lg border border-slate-100 mt-8 mb-8">
                            <div className="flex items-center justify-between mb-4 border-b border-slate-100 pb-4">
                                <div className="flex items-center gap-2"><History className="w-5 h-5 text-slate-400" /><h3 className="font-bold text-slate-500 text-xs uppercase tracking-wider">Storico</h3></div>
                                <button onClick={() => setConfirmModal({isOpen: true, title: "Reset", message: "Cancelli tutto?", onConfirm: handleReset, isDestructive: true})} className="text-xs text-red-300 hover:text-red-500 hover:bg-red-50 px-3 py-1.5 rounded-lg transition-colors flex items-center gap-1 font-bold"><Trash2 className="w-3.5 h-3.5" /> Reset</button>
                            </div>
                            <div className="space-y-1 max-h-64 overflow-y-auto pr-2 scrollbar-thin scrollbar-thumb-slate-200 scrollbar-track-transparent">
                                {history.length === 0 ? (<div className="text-center py-10 text-slate-400 text-sm flex flex-col items-center"><Sparkles className="w-10 h-10 text-slate-200 mb-3" />Nessuna attivit√†</div>) : (history.map((item, idx) => (
                                    <div key={idx} className="flex justify-between items-center text-sm py-3 border-b border-slate-50 last:border-0 px-3 rounded-xl"><div className="flex flex-col"><span className="font-bold text-slate-700 text-base">{item.desc}</span><span className="text-xs text-slate-400 font-mono mt-0.5">{new Date(item.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span></div><span className={`font-bold px-3 py-1.5 rounded-lg text-sm min-w-[50px] text-center ${item.points > 0 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>{item.points > 0 ? '+' : ''}{item.points}</span></div>
                                )))}
                            </div>
                        </section>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
